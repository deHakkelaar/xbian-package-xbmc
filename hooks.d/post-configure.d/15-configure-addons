
case $config_platform_branch in
    *-nightly*|*-isengard|*-jarvis)
        ;;
    *)
        exit
        ;;
esac

[ ! -e $XBIANROOT/common.functions ] || . $XBIANROOT/common.functions && { [ ! -e ../env ] || rexp ../env; }

cd project/cmake

# Testing
if [ x"$config_source_reset" = x"donotrun" ]; then
    [ -d ../cmake.afterprepare ] && [ -e ../cmake.afterprepare/kodi-config.cmake ] || rsync --delete -aAXH ./ ../cmake.afterprepare/
    echo $config_build_env
    echo $config_build_addons
    rsync -aAXH --delete ../cmake.afterprepare/ .
fi
# Testing end

# CMake makes some strange things if running multiple times with already
# existing CMakeCache.txt. So it's better to remove before running cmake
[ -e addons/build/CMakeCache.txt ] && rm -f addons/build/CMakeCache.txt || :

if $config_build_env c++ --version | grep -q "4.6"; then
    echo "Warning: You are using g++ 4.6, pvr.vbox and pvr.stalker will currently not compiled without errors, so removing it from source tree"
    echo "         If you need this addon, you have to use g++ 4.7"
    [ -d ./addons/addons/pvr.vbox ] && rm -rf ./addons/addons/pvr.vbox || :
    [ -d ./addons/addons/pvr.stalker ] && rm -rf ./addons/addons/pvr.stalker || :
fi

[ -d addons/build ] || mkdir addons/build
cd addons/build
PREFIX=/usr/local

case $config_platform_branch in
    *-jarvis)
        for f in $config_build_addons; do
            eval $config_build_env cmake -DADDONS_TO_BUILD=$f -DOVERRIDE_PATHS=1 -DCMAKE_INSTALL_DESTDIR=$PREFIX -DCMAKE_INSTALL_PREFIX=$XBIANPKGDIR/content/$PREFIX \
                -DBUILD_DIR=$(readlink -f ./) -DCMAKE_RULE_MESSAGES=OFF -DADDONS_DEFINITION_DIR=$(readlink -f ./bootstrap) ..
            break
        done
        [ -z "$f" ] || rm -fr ../$f
        ;;
    *)
        exit
        ;;
esac

eval $config_build_env cmake -DADDONS_TO_BUILD=\"$config_build_addons\" -DOVERRIDE_PATHS=1 -DCMAKE_INSTALL_DESTDIR=$PREFIX -DCMAKE_INSTALL_PREFIX=$XBIANPKGDIR/content/$PREFIX \
  -DBUILD_DIR=$(readlink -f ./) -DCMAKE_RULE_MESSAGES=OFF -DADDONS_DEFINITION_DIR=$(readlink -f ./bootstrap) ..
